# Тестовое задание

Создать api приложение на Django с использованием DRF в области коммунальных услуг
<hr>

## Содержание

1. [Основные требования задания](#main_requirements)
2. [Стек технологий](#technology_stack)
3. [Документация по API](#doc_api)
4. [Инструкция по запуску проекта](#instruction_startup)
5. [Дополнительная функциональность](#add_func)

## Основные требования задания <a name="main_requirements"></a>

1. Реализовать модели данных «Дом», «Квартира», «Счётчик воды», «Тариф», учитывая связи между ними.<br>
   В доме может быть много квартир. В квартире может быть несколько счётчиков.<br>
   У квартиры должна быть площадь (будет нужно для расчёта платы за содержание общего имущества).<br>
   Для счётчика нужно хранить показания за несколько прошедших месяцев.<br>
   Тариф — это цена услуги или ресурса (например, цена за единицу объёма воды), используется для расчёта платы за 
   коммунальные услуги.
2. Реализовать API для ввода и вывода данных по дому (например, адрес дома, список квартир и т. п., должны выводиться 
   данные из нескольких моделей).
3. Реализовать функцию расчёта квартплаты для всех квартир в доме за какой-либо месяц. Результаты записывать в БД. 
   Функция должна сохранять прогресс расчёта.<br>
   Квартплата включает в себя:<br>
   ● Водоснабжение.<br>
   Рассчитывается по расходу воды за месяц
   (тариф_за_единицу_объёма × расход).<br> Расход — это разница между показаниями
   счётчика за текущий и за предыдущий месяц.<br>
   ● Содержание общего имущества.<br> 
   Рассчитывается на основе площади квартиры
   (тариф_за_единицу_площади × площадь_квартиры).
4. Реализовать API, которое запускает процесс расчёта квартплаты в фоновом режиме (например в celery), и затем 
   позволяет получить прогресс расчёта.

## Стек технологий <a name="technology_stack"></a>
- Backend: [Django](https://www.djangoproject.com/), [Django Rest Framework](https://www.django-rest-framework.org/)
- База данных: [PostgreSQL](https://www.postgresql.org/)
- Контроль версий: [Git](https://git-scm.com/), [GitHub](https://github.com/)
- Контейнеризация: [Docker](https://www.docker.com/)
- Асинхронность: [Celery](https://docs.celeryq.dev/)
- Брокер сообщений: [Redis](https://redis.io/)
- Документация: [DRF YASG](https://drf-yasg.readthedocs.io/en/stable/readme.html)

## Документация по API <a name="doc_api"></a>

- Swagger: http://localhost:8000/swagger/
- Redoc: http://localhost:8000/redoc/

## Инструкция по запуску проекта <a name="instruction_startup"></a>

1. Клонируйте репозиторий
```
git clone https://github.com/VitaliyKozhushko/communal_task
```
2. Настройте .env файлы: .env - обычный запуск, .env.docker - запуск с помощью Docker.
3. Запустите проект:
   * (суперпользователь будет автоматически создан - login: admin, password - admin)
   - либо с помощью команд Django (предварительно активировать виртуальное окружение):
   ```
    pip install -r requirements.txt
    python manage.py collectstatic
    python manage.py makemigrations
    python manage.py migrate
    python create_superuser.py
    python manage.py runserver
    ```
   - либо с помощью Docker
    ```
    docker compose up --build -d
    ```
4. Перейти на http://localhost:8000/admin или http://127.0.0.1:8000/admin

## Реализованная дополнительная функциональность <a name="add_func"></a>

Дополнительная функциональность разделена по частям задания

#### 1
- в карточке дома можно посмотреть список квартир, относящихся к дому и сразу перейти в нужную
  кликнув на ссылку
- в карточке квартиры можно посмотреть список счетчиков, относящихся к квартире
- список квартир можно сортировать также по площади и дому
- список квартир можно фильтровать по дому
- доавлена модель для создания типов счетчиков (ХВС, ГВС и т.д.)
- для простоты выполнения тестового задания показания счетчика должны иметь вид:
{
    "2024-01": 120.5,
    "2024-02": 135.7,
    "2024-03": 142.9
}
- счетчики можно фильтровать по квартире и по дому
- при добавлении тарифа можно выбрать либо тип счетчика, либо указать название:
  - если выбран тип счетчика, то необходимо указать только цену. Ед. измерения автоматически подтянется из данных по счетчику
  - если указать название, то необходимо указать и единицу измерения

#### 2

Роуты доступны авторизованным и неавторизованным пользователям, поскольку в ТЗ данного условия не было

Здесь представлен краткий список API. Более подробно описано в документации по API (Swagger/Redoc)

Реализовано следующее API
 - 'api/house/id/' - данные по опр. дому ( содержит адрес, список квартир, список счетчиков внутри квартиры)
 - 'api/houses' - список всех домов
 - 'api/apartment/id/' - данные по квартире
 - 'api/meters/house/house_id/' (api/meters/house/house_id/?apartment_id=flat_id) - список счетчиков для опр. дома с возможностью фильтрации по квартире
 - 'api/meters/id/' - данные по опр счетчику
 - 'api/houses' - добавление домов
 - 'api/apartments/' - добавление квартир
 - 'api/meters/' - добавление счетчиков
 - 'api/houses/id/' - редактирование дома
 - 'api/apartment/id/' - редактирование квартиры
 - 'api/meter/id/' - редактирование счетчика
 - 'api/meter-types' - получение типов счетчиков
 - 'api/house/house_id/calculate_bills/' - запуск расчета квартплаты для опр дома
 - 'api/tasks/celery_task_id/result/' - статус расчета квартплаты и результат

#### 3

- если счетчик установлен в квартире (есть данные о нем)
  - для первого измерения счетчика, данные за предыдущий период равны 0
  - если отсутствуют показания за текущий месяц (кроме начального), но счетчик был установлен, мы будем брать средний расход за последние три месяца, 
    если такие данные есть; если данных недостаточно, то всё равно используем известные значения для расчёта среднего.
    Т.е. среднее потребление за предыдущие 3 месяца рассчитывается для случаев, когда показание пропущено, но счетчик 
    уже был установлен.
  - если показаний нет за период, который был раньше установки счетчика, то прилетает поле "absent_meters" включающее 
    список счетчиков, по которым нет данных
    ```
    "absent_meters": [
            {
                "id": 2,
                "name": "Electricity"
            }
        ]
    ```
- для расчетов, не связанных со счетчиками, исп. м2
- поддержка неограниченного расчета разных тарифов (со счетчиками и без).
- округление расчета до сотых
- формат JSON для ответа:
```
{
    "apartment_id": 1,
    "apartment_number": 101,
    "house_id": 1,
    "address": "123 Main Street",
    "date": "2024-08-01",
    "calc_rent": [
      {
        "id": 5,
        "name": "maintenance",
        "consumption": 45.0,
        "unit": "m2",
        "cost": 225.00
      },
      {
        "id": 2,
        "name": "Water",
        "consumption": 15.20,
        "unit": "m3",
        "cost": 30.40
      }
    ]
  },
```
#### 4

- прогресс выполнения в рамках тестового задания имеет статусы (TaskResultView)
- поскольку кол-во данных небольшое для расчета, в запрос можно передать дополнительный пар-р (delay), который имитирует
  задержку в секундах
Порядок работы:
  - клиент отправляет запрос на 'api/house/house_id/calculate_bills/ для запуска расчета
  - клиент запрашивает переодически запрашивает статус по 'api/tasks/cellery_task_id/result/'
  - на фронте id задачи celery можно сохранить либо в LocalStorage либо в IndexedDB
  - как только задача будет завершена, в ответе кроме статуса прилетит результат расчета

#### Допы

- добавлена проверка на отрицательную площадь квартиры через кастомный валидатор
- добавлена проверка на отрицательные значения для счетчика квартиры
- при добавлении счетчика с показаниями добавлена проверка:
  - отрицательное значение
  - максимум 1 месяц
  - месяц в показаниях либо текущий либо предыдущий
- редактирование показаний счетчика (максимально приближено к реальности):
  - если показаний нет, то месяц либо текущий либо предыдущий
  - если показания есть, то месяц не меньше самого раннего месяца в существующих показаниях
  - передаваться можно показания только за 1 месяц за раз
  - если уже есть запись за указанный месяц, то падает ошибка, что показания уже существуют
  - если показаний нет за указанный месяц в запросе, то вносятся показания
  - формат отправки показаний
    ```
    {"2024-06": "150"}
    ```
- автоматическое создание админа
